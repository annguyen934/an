-- Link raw chứa danh sách user hợp lệ (keys.json)
local URL_KEYS = "https://raw.githubusercontent.com/annguyen934/an/refs/heads/main/keys.json"
-- Link raw script sẽ chạy nếu user hợp lệ
local URL_SCRIPT = "https://raw.githubusercontent.com/annguyen934/an/refs/heads/main/an"

-- Hàm parse JSON đơn giản (chỉ dùng cho JSON đơn giản kiểu { "user": true, ... })
local function simpleJsonDecode(str)
    local f, err = load("return " .. str:gsub("null", "nil"))
    if not f then return nil, err end
    local ok, result = pcall(f)
    if ok then return result else return nil, result end
end

-- Hàm tải file JSON user từ GitHub
local function getUserList()
    local response = gg.makeRequest(URL_KEYS)
    if response.status == 200 then
        local userList, err = simpleJsonDecode(response.content)
        if not userList then
            gg.alert("Lỗi phân tích JSON: " .. tostring(err))
            return nil
        end
        return userList
    else
        gg.alert("Lỗi tải keys.json: HTTP " .. tostring(response.status))
        return nil
    end
end

-- Hàm kiểm tra tên đăng nhập hợp lệ
local function isUserValid(userList, username)
    return userList[username] == true
end

-- Hàm yêu cầu nhập tên đăng nhập
local function getUsername()
    local input = gg.prompt({"Nhập tên đăng nhập:"}, {""}, {"text"})
    if input and input[1] and input[1] ~= "" then
        return input[1]
    else
        gg.alert("Bạn chưa nhập tên đăng nhập!")
        os.exit()
    end
end

-- Main
local function main()
    local username = getUsername()
    gg.toast("Đang kiểm tra tên đăng nhập...")
    local userList = getUserList()
    if not userList then
        gg.alert("Không thể lấy danh sách đăng nhập!")
        os.exit()
    end

    if isUserValid(userList, username) then
        gg.alert("Đăng nhập thành công! Đang tải script...")
        gg.loadScript(URL_SCRIPT)
    else
        gg.alert("Tên đăng nhập không hợp lệ!")
        os.exit()
    end
end

main()
